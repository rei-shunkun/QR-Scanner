<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>iOS 强制后置扫码</title>
  <script src="https://unpkg.com/html5-qrcode@2.3.10/html5-qrcode.min.js"></script>
  <style>
    #qr-reader {
      width: 300px;
      margin: auto;
      border: 1px solid #1976d2;
      border-radius: 8px;
      overflow: hidden;
    }
    #settings, #capabilities {
      font-size: 0.9em;
      white-space: pre-wrap;
      background: #f0f0f0;
      padding: 8px;
      margin: 10px 0;
    }
  </style>
</head>
<body>

  <h3>扫码演示</h3>
  <button onclick="startScanner()">开始扫码</button>
  <div id="qr-reader"></div>
  <div id="settings">🎛️ <strong>Settings:</strong></div>
  <div id="capabilities">📋 <strong>Capabilities:</strong></div>
  <div><strong>扫码结果：</strong><span id="scan-result">无</span></div>

  <!-- 加载 html5-qrcode 库 -->
  <script src="https://unpkg.com/html5-qrcode@2.3.10/html5-qrcode.min.js"></script>

  <script>
    async function startScanner() {
      const devices = await navigator.mediaDevices.enumerateDevices();
      const videoDevices = devices.filter(d => d.kind === 'videoinput');

      // 优先尝试使用后置摄像头
      const backCamera = videoDevices.find(d => d.label.toLowerCase().includes('back')) || videoDevices[0];

      const readerId = "qr-reader";
      const qrScanner = new Html5Qrcode(readerId);

      // 设置扫码配置
      const config = {
        fps: 10,
        qrbox: { width: 250, height: 250 },
        aspectRatio: 1.777,
        advanced: [{ zoom: 3 }],
        videoConstraints: {
          deviceId: { exact: backCamera.deviceId },
          facingMode: "environment",
          width: { ideal: 1920 },
          height: { ideal: 1080 },
          focusMode: "continuous",
          advanced: [{ zoom: 3 }]
        }
      };

      qrScanner.start(
        config.videoConstraints,
        config,
        (decodedText) => {
          document.getElementById("scan-result").textContent = decodedText;
          qrScanner.stop().then(() => qrScanner.clear());
        },
        (err) => {
          console.warn(err);
        }
      ).then(() => {
        const video = document.querySelector(`#${readerId} video`);
        if (video) {
          const track = video.srcObject.getVideoTracks()[0];
          const settings = track.getSettings();
          const capabilities = track.getCapabilities ? track.getCapabilities() : {};

          document.getElementById("settings").textContent = `🎛️ Settings:\n${JSON.stringify(settings, null, 2)}`;
          document.getElementById("capabilities").textContent = `📋 Capabilities:\n${JSON.stringify(capabilities, null, 2)}`;
        }
      });
    }
  </script>
</body>
</html>
